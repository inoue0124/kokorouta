default_platform(:ios)

platform :ios do
  # ============================================================
  # Build
  # ============================================================
  desc "Build the app"
  lane :build do
    xcodebuild(
      scheme: ENV["SCHEME"] || "App",
      configuration: "Debug",
      build: true,
      destination: "generic/platform=iOS Simulator",
      xcargs: "CODE_SIGNING_ALLOWED=NO"
    )
  end

  # ============================================================
  # Test
  # ============================================================
  desc "Run tests"
  lane :test do
    run_tests(
      scheme: ENV["SCHEME"] || "App",
      destination: "platform=iOS Simulator,name=iPhone 16",
      clean: true,
      code_coverage: true,
      output_directory: "fastlane/test_output",
      result_bundle: true,
      xcargs: "CODE_SIGNING_ALLOWED=NO"
    )
  end

  # ============================================================
  # Beta (TestFlight)
  # ============================================================
  desc "Build and upload to TestFlight"
  lane :beta do
    begin
      # Required secrets: ASC_KEY_ID, ASC_ISSUER_ID, ASC_KEY_CONTENT
      app_store_connect_api_key(
        key_id: ENV["ASC_KEY_ID"],
        issuer_id: ENV["ASC_ISSUER_ID"],
        key_content: ENV["ASC_KEY_CONTENT"],
        is_key_content_base64: true
      )

      # Required secrets: MATCH_PASSWORD, MATCH_GIT_BASIC_AUTHORIZATION
      match(type: "appstore", readonly: true)

      increment_build_number
      build_app(scheme: ENV["SCHEME"] || "App")
      upload_to_testflight(skip_waiting_for_build_processing: true)
    rescue => e
      UI.error("Beta deployment failed: #{e.message}")
      raise e
    end
  end
end
