default_platform(:ios)

platform :ios do
  # ============================================================
  # Build
  # ============================================================
  desc "Build the app"
  lane :build do
    xcodebuild(
      scheme: ENV["SCHEME"] || "App",
      configuration: "Debug",
      build: true,
      destination: "generic/platform=iOS Simulator",
      xcargs: "CODE_SIGNING_ALLOWED=NO"
    )
  end

  # ============================================================
  # Test
  # ============================================================
  desc "Run tests"
  lane :test do
    run_tests(
      scheme: ENV["SCHEME"] || "App",
      destination: "platform=iOS Simulator,name=iPhone 16",
      clean: true,
      code_coverage: true,
      output_directory: "fastlane/test_output",
      result_bundle: true,
      xcargs: "CODE_SIGNING_ALLOWED=NO"
    )
  end

  # ============================================================
  # Beta (TestFlight) — ローカル向け
  # ============================================================
  desc "Build and upload to TestFlight (local)"
  lane :beta do
    increment_build_number(
      xcodeproj: "App.xcodeproj"
    )
    build_app(
      scheme: ENV["SCHEME"] || "App",
      export_method: "app-store",
      xcargs: "DEVELOPMENT_TEAM=3HFF5L44FR"
    )
    upload_to_testflight(
      apple_id: "inoue-yusuke@carri-age.com",
      skip_waiting_for_build_processing: true
    )
  end

  # ============================================================
  # Beta (TestFlight) — CI 向け
  # ============================================================
  desc "Build and upload to TestFlight (CI)"
  lane :beta_ci do
    app_store_connect_api_key(
      key_id: ENV["ASC_KEY_ID"],
      issuer_id: ENV["ASC_ISSUER_ID"],
      key_content: ENV["ASC_KEY_CONTENT"],
      is_key_content_base64: true
    )

    match(type: "appstore", readonly: true)

    increment_build_number(
      xcodeproj: "App.xcodeproj"
    )
    build_app(
      scheme: ENV["SCHEME"] || "App",
      export_method: "app-store"
    )
    upload_to_testflight(skip_waiting_for_build_processing: true)
  end

  # ============================================================
  # Release (App Store)
  # ============================================================
  desc "Build and upload to App Store for review"
  lane :release do
    increment_build_number(
      xcodeproj: "App.xcodeproj"
    )
    build_app(
      scheme: ENV["SCHEME"] || "App",
      export_method: "app-store",
      xcargs: "DEVELOPMENT_TEAM=3HFF5L44FR"
    )
    upload_to_app_store(
      skip_metadata: true,
      skip_screenshots: true,
      precheck_include_in_app_purchases: false
    )
  end
end
