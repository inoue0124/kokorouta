default_platform(:ios)

platform :ios do
  # ============================================================
  # Build
  # ============================================================
  desc "Build the app"
  lane :build do
    xcodebuild(
      scheme: ENV["SCHEME"] || "App",
      configuration: "Debug",
      build: true,
      destination: "generic/platform=iOS Simulator",
      xcargs: "CODE_SIGNING_ALLOWED=NO"
    )
  end

  # ============================================================
  # Test
  # ============================================================
  desc "Run tests"
  lane :test do
    run_tests(
      scheme: ENV["SCHEME"] || "App",
      destination: "platform=iOS Simulator,name=iPhone 16",
      clean: true,
      xcargs: "CODE_SIGNING_ALLOWED=NO"
    )
  end

  # ============================================================
  # Beta (TestFlight)
  # ============================================================
  desc "Build and upload to TestFlight"
  lane :beta do
    begin
      increment_build_number
      build_app(
        scheme: ENV["SCHEME"] || "App",
        export_method: "app-store"
      )
      upload_to_testflight(
        skip_waiting_for_build_processing: true
      )
    rescue => e
      UI.error("Beta lane failed: #{e.message}")
      raise e
    end
  end

  # ============================================================
  # Gym (Build only)
  # ============================================================
  desc "Build the app for distribution (without uploading)"
  lane :gym_build do
    build_app(
      scheme: ENV["SCHEME"] || "App",
      export_method: "app-store",
      skip_upload: true
    )
  end
end
