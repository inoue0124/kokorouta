# 要件定義書: サーバー側悩み入力バリデーション

> Issue: #19
> 生成日時: 2026-02-27
> ステータス: Draft

## 1. 概要

意味のない文字列や極端に短い入力など、質の低い悩みテキストが送信された場合にサーバー側で生成を拒否し、OpenAI API の無駄な呼び出しとコストを防ぐ。さらに、AI 生成時にも入力品質を判定し、低品質な入力は生成後でも弾く。

## 2. 背景・動機

- 「あああ」「test」「あ」など意味のない入力でも現状は OpenAI API が呼ばれ、コストが発生する
- 1日1回の生成制限があるため、質の低い入力で枠を消費するとユーザー体験も悪い
- サーバー側でバリデーションすることで、クライアント改ざんによるバイパスも防止できる

## 3. 機能要件

### FR-1: サーバー側バリデーションルール（プレチェック）

OpenAI API 呼び出し前に実行する静的バリデーション。

| # | ルール | 条件 | エラーメッセージ |
|---|---|---|---|
| V-1 | 最低文字数 | トリム後 10 文字未満 | もう少し詳しく悩みを書いてください |
| V-2 | 最大文字数 | 300 文字超過 | 悩みは300文字以内で入力してください |
| V-3 | 同一文字繰り返し | 全体の 70% 以上が同一文字 | 悩みの内容を具体的に書いてください |
| V-4 | 空白のみ | トリム後に空 | 悩みのテキストを入力してください（既存） |

### FR-2: AI 品質判定（ポストチェック）

OpenAI API にプロンプトで品質判定フラグを返させ、低品質な入力は生成後でも拒否する。

- OpenAI レスポンスに `isValidInput` フラグを含めるようプロンプトを修正する
- `isValidInput: false` の場合、短歌を保存せず日次制限も消費しない
- クライアントには `invalid-argument` エラーで「悩みの内容をもう少し具体的に書いてください」を返す

### FR-3: バリデーション実行タイミング

- 静的バリデーション（FR-1）は日次制限チェック・Firestore アクセスの **前** に配置する
- AI 品質判定（FR-2）は短歌生成後・Firestore 保存 **前** に実行する
- いずれの拒否でも日次制限のカウントを消費しない

### FR-4: エラーレスポンス

- Firebase Cloud Functions のエラーコード `invalid-argument` を使用する
- エラーメッセージはバリデーションルールに対応した日本語メッセージを返す

### FR-5: iOS 側エラー表示

- サーバーから `invalid-argument` エラーが返された場合、バリデーションエラーとして処理する
- `NetworkError` に `invalidArgument(message:)` ケースを追加する
- `AppError` で `invalidArgument` を `.validation(message)` にマッピングする
- TankaResultView でバリデーションエラー時は「戻って修正する」ボタンを表示する

### FR-6: iOS 側クライアントバリデーション強化

- ComposeView の文字数上限を 200 → 300 に更新する
- ComposeViewModel の `isValid` に最大文字数 300 を反映する

## 4. 非機能要件

- バリデーション処理はサーバーサイドのみで完結すること（クライアント側は UX 向上のためのプレバリデーション）
- 静的バリデーションは Firestore アクセスの前に実行し、不要な DB 読み取りを防ぐ

## 5. 受け入れ条件

- [ ] AC-1: 10 文字未満の入力がサーバーで拒否される
- [ ] AC-2: 300 文字超過の入力がサーバーで拒否される
- [ ] AC-3: 同一文字の繰り返し（70%以上）がサーバーで拒否される
- [ ] AC-4: AI が低品質と判定した入力が拒否される
- [ ] AC-5: 拒否時に適切なエラーメッセージがクライアントに返される
- [ ] AC-6: 日次制限のカウントが消費されない（バリデーション・AI品質判定いずれの拒否でも）
- [ ] AC-7: iOS 側でバリデーションエラーメッセージが表示され、再入力を促す
- [ ] AC-8: iOS 側の文字数上限が 300 文字に更新される

## 6. スコープ外

- ブラックリスト / 禁止ワード検出
- 入力内容の感情分析
